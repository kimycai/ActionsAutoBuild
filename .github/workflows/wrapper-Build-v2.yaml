name: wrapper-Build-v2
on:
  workflow_dispatch:  # 仅手动触发

jobs:
  build:
    runs-on: ubuntu-24.04  # Ubuntu 24.04构建环境
    steps:
      # 1. 拉取官方源码到CI根目录wrapper/子目录
      - name: Checkout WorldObservationLog/wrapper source code
        uses: actions/checkout@v4
        with:
          repository: WorldObservationLog/wrapper
          path: wrapper
          fetch-depth: 1

      # 2. 安装编译依赖（兼容官方+Ubuntu24.04新环境）
      - name: Install build dependencies
        run: |
          sudo apt update -y
          sudo apt install -y aria2 build-essential cmake wget unzip git
          sudo apt update --fix-missing -y

      # 3. 安装LLVM（与官方一致）
      - name: Install LLVM
        run: sudo bash -c "$(wget -O - https://apt.llvm.org/llvm.sh)"

      # 4. 配置Android NDK r23b（aria2c下载，与官方一致）
      - name: Set up Android NDK r23b
        run: | 
          aria2c -o android-ndk-r23b-linux.zip https://dl.google.com/android/repository/android-ndk-r23b-linux.zip
          unzip -q -d ~ android-ndk-r23b-linux.zip
        working-directory: wrapper

      # 5. 显式配置NDK环境变量（Ubuntu24.04兼容性）
      - name: Set ANDROID_NDK_HOME
        run: echo "ANDROID_NDK_HOME=~/android-ndk-r23b" >> $GITHUB_ENV

      # 6. 核心构建流程（与官方一致，多核编译优化）
      - name: Build
        run: |
          mkdir -p build
          cd build
          cmake ..
          make -j$(nproc)
        working-directory: wrapper

      # 7. 校验wrapper可执行文件（存在+可执行权限，精准路径）
      - name: Verify wrapper executable exists
        run: |
          EXEC_PATH="wrapper/wrapper"
          if [ ! -x "$EXEC_PATH" ]; then
            echo "ERROR: wrapper可执行文件不存在，路径：$EXEC_PATH"
            exit 1
          fi
          echo "✅ 产物验证通过：$EXEC_PATH（存在且具备可执行权限）"

      # 8. 上传wrapper作为GitHub Action产物（备用，可手动下载）
      - name: Upload wrapper executable artifact
        uses: actions/upload-artifact@v4
        with:
          name: wrapper-executable-ubuntu2404
          path: wrapper/wrapper

      # 9. 配置Git全局信息（适配Gitee提交，识别提交者）
      - name: Configure Git for Gitee
        run: |
          git config --global user.name "kimycai"
          git config --global user.email "kimycai@users.noreply.gitee.com"

      # 10. 拉取你的Gitee仓库（kimycai/amdl-web-manager）到CI环境
      - name: Checkout your Gitee repository (kimycai/amdl-web-manager)
        uses: actions/checkout@v4
        with:
          repository: kimycai/amdl-web-manager
          ref: main  # 推送目标分支（默认main，若为master可自行修改）
          token: ${{ secrets.GITEE_TOKEN }}  # 你的Gitee令牌（已配置在GitHub Secrets）
          path: gitee-repo  # 仓库存放目录，与源码目录隔离，避免冲突

      # 11. 复制编译好的wrapper到Gitee仓库目录（强制覆盖原有文件）
      - name: Copy wrapper to Gitee repo directory
        run: |
          cp -f wrapper/wrapper gitee-repo/
          ls -l gitee-repo/wrapper  # 验证复制结果，日志可查文件信息

      # 12. 推送wrapper到Gitee仓库（条件推送，无变更则跳过）
      - name: Push wrapper to Gitee (kimycai/amdl-web-manager)
        run: |
          cd gitee-repo
          # 检查wrapper文件是否有变更，避免无意义提交
          if git status --porcelain | grep -q "wrapper"; then
            git add wrapper
            git commit -m "Auto update wrapper executable [Ubuntu24.04 build]"
            git push origin main
            echo "✅ wrapper可执行文件已成功推送到Gitee仓库：kimycai/amdl-web-manager！"
          else
            echo "ℹ️  wrapper文件无变更，无需推送至Gitee仓库"
          fi
        env:
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}

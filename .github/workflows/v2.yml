name: st0rmMusic 打包ubuntu-latest整环境推送到GHCR
# 仅手动触发，避免误操作
on:
  workflow_dispatch:

jobs:
  build-env-image-and-push:
    runs-on: ubuntu-latest
    # 赋予GITHUB_TOKEN精准权限，满足拉取仓库、推送GHCR需求
    permissions:
      contents: read
      packages: write
      id-token: write
    steps:
      # 步骤1：拉取仓库（含子模块，核心项目文件）
      - name: 拉取st0rmMusicPlayer仓库（含子模块）
        uses: actions/checkout@v4
        with:
          repository: sn0wst0rm/st0rmMusicPlayer
          ref: main
          submodules: recursive
          path: st0rmMusicPlayer
          token: ${{ secrets.GITHUB_TOKEN }}

      # 步骤2：下载并配置FFmpeg（音频处理核心依赖，全局可用）
      - name: 安装FFmpeg（从BtbN/FFmpeg-Builds下载）
        run: |
          FFMPEG_URL="https://github.com/BtbN/FFmpeg-Builds/releases/download/latest/ffmpeg-n8.0-latest-linux64-lgpl-8.0.tar.xz"
          curl -L -O -S -f $FFMPEG_URL
          
          FFMPEG_TAR="ffmpeg-n8.0-latest-linux64-lgpl-8.0.tar.xz"
          if [ ! -f "$FFMPEG_TAR" ]; then
            echo "ERROR: FFmpeg压缩包下载失败！"
            ls -l
            exit 1
          fi

          sudo mkdir -p /opt/ffmpeg
          sudo tar -xJf "$FFMPEG_TAR" -C /opt/ffmpeg --strip-components=1
          
          echo "/opt/ffmpeg/bin" >> $GITHUB_PATH
          export PATH="/opt/ffmpeg/bin:$PATH"
          
          ffmpeg -version
          ffprobe -version
          echo "=== FFmpeg安装完成，全局可用 ==="

      # 步骤3：配置Node.js 20.19.0（匹配项目运行环境，缓存依赖）
      - name: 配置Node.js 20.19.0
        uses: actions/setup-node@v4
        with:
          node-version: '20.19.0'
          cache: 'npm'
          cache-dependency-path: st0rmMusicPlayer/package-lock.json

      # 步骤4：配置Python 3.9（项目后端/gamdl必需，缓存依赖）
      - name: 配置Python 3.9
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
          cache: 'pip'

      # 步骤5：安装Ubuntu系统依赖（修复sudo权限，清理缓存无报错）
      - name: 安装系统级依赖
        run: sudo apt update && sudo apt install -y python3-venv && sudo rm -rf /var/lib/apt/lists/*

      # 步骤6：初始化项目运行环境（免交互执行setup.sh，CI环境标记）
      - name: 初始化项目运行环境
        run: |
          chmod +x st0rmMusicPlayer/setup.sh
          cd st0rmMusicPlayer
          echo "" | bash ./setup.sh
        env:
          CI: true

      # 步骤7：修复项目缺失依赖（解决运行时CSS解析报错）
      - name: 修复项目运行依赖
        run: |
          cd st0rmMusicPlayer
          npm install @tailwindcss/postcss --save-dev

      # 步骤8：验证docker环境可用性（提前规避docker命令/守护进程异常）
      - name: 验证docker环境可用性
        run: |
          if ! command -v docker &> /dev/null; then
            echo "ERROR: Action环境中未安装docker！"
            exit 1
          fi
          if ! docker ps &> /dev/null; then
            echo "ERROR: docker守护进程未启动！"
            exit 1
          fi
          echo "docker环境验证通过，版本：$(docker --version)"

      # 步骤9：获取当前ubuntu-latest运行容器ID（适配cgroup v2，非空校验）
      - name: 获取当前ubuntu-latest运行容器ID
        id: get_container_id
        run: |
          # 兼容cgroup v1/v2的通用方式，获取容器ID
          CONTAINER_ID=$(grep -oP 'docker/\K[0-9a-f]+' /proc/self/cgroup | head -1)
          # 非空校验，未获取到则终止
          if [ -z "$CONTAINER_ID" ]; then
            echo "ERROR: 未能获取到Action运行容器ID，环境不兼容！"
            exit 1
          fi
          echo "container_id=$CONTAINER_ID" >> $GITHUB_OUTPUT
          echo "当前Action运行容器ID：$CONTAINER_ID"
          # 验证容器存在
          docker ps | grep $CONTAINER_ID

      # 步骤10：登录GHCR（使用Action内置GITHUB_TOKEN，免手动PAT）
      - name: 登录GitHub Container Registry (GHCR)
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # 步骤11：打包ubuntu-latest完整运行环境为Docker镜像（docker commit核心步骤）
      - name: 打包ubuntu-latest完整运行环境为镜像
        run: |
          # 定义GHCR规范镜像信息
          IMAGE_NAME="st0rm-music-ubuntu-env"
          IMAGE_TAG="latest"
          IMAGE_FULL_NAME="ghcr.io/${{ github.repository_owner }}/$IMAGE_NAME:$IMAGE_TAG"
          
          # 核心：将Action运行容器打包为镜像
          docker commit ${{ steps.get_container_id.outputs.container_id }} $IMAGE_FULL_NAME
          
          # 验证镜像创建成功
          echo "=== 镜像打包完成，镜像信息 ==="
          docker images | grep $IMAGE_NAME
          echo "镜像完整地址：$IMAGE_FULL_NAME"

      # 步骤12：推送完整环境镜像到GHCR（一键推送，无需额外构建）
      - name: 推送完整环境镜像到GHCR
        run: |
          IMAGE_NAME="st0rm-music-ubuntu-env"
          IMAGE_TAG="latest"
          IMAGE_FULL_NAME="ghcr.io/${{ github.repository_owner }}/$IMAGE_NAME:$IMAGE_TAG"
          
          # 推送镜像
          docker push $IMAGE_FULL_NAME
          
          echo "=== 镜像推送成功！==="
          echo "拉取命令：docker pull $IMAGE_FULL_NAME"
          echo "启动容器命令：docker run -d --name st0rm-music-app -p 3000:3000 --restart always $IMAGE_FULL_NAME npm start --prefix /github/workspace/st0rmMusicPlayer"

name: Build apple-music-rip (Ubuntu 24.04)
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch: # 手动触发构建

# 并发控制：取消同分支正在进行的构建，避免资源浪费
concurrency:
  group: ${{ github.ref }}-apple-music-rip-ubuntu2404
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-24.04 # 固定Ubuntu 24.04运行器
    steps:
      - name: 1. 检出原项目代码（根目录检出，无嵌套）
        uses: actions/checkout@v4
        with:
          fetch-depth: 1 # 浅克隆加速，仅拉取最新代码

      - name: 2. 修复Ubuntu 24.04依赖锁&更新软件源
        run: |
          sudo rm -f /var/lib/dpkg/lock-frontend
          sudo dpkg --configure -a
          sudo apt update -y && sudo apt upgrade -y --no-install-recommends
          sudo apt clean

      - name: 3. 安装项目必要系统依赖（无Java、无冗余）
        run: |
          sudo apt install -y --no-install-recommends \
            build-essential \
            git \
            curl \
            wget \
            unzip \
            zip \
            python3 \
            python3-pip \
            python3-venv \
            libssl-dev \
            pkg-config \
            golang-go \
            net-tools # 用于后续端口验证
          # 清理缓存，减小镜像体积
          sudo apt autoremove -y && sudo apt clean
          # 验证核心依赖版本
          echo "Python版本：$(python3 --version)"
          echo "Go版本：$(go version)"

      - name: 4. 配置Python虚拟环境&安装Web核心依赖
        run: |
          # 强制在项目根目录操作
          cd $GITHUB_WORKSPACE
          # 创建并激活虚拟环境
          python3 -m venv .venv
          source .venv/bin/activate
          # 升级pip并安装适配依赖（匹配原项目Flask Web层）
          pip install --upgrade pip
          pip install flask==2.3.3 flask-cors==4.0.0 requests==2.31.0
          # 导出依赖清单，便于本地复现
          pip freeze > requirements.txt

      - name: 5. 彻底移除Nix相关逻辑（修复文件找不到问题，核心修正）
        run: |
          # 强制切换到GitHub Actions项目根目录（绝对路径，彻底避免路径问题）
          cd $GITHUB_WORKSPACE
          # 校验main.py是否存在，不存在则直接报错终止
          if [ ! -f "main.py" ]; then
            echo "❌ 项目根目录未找到main.py文件，检查代码检出步骤！"
            ls -l # 打印目录文件，便于排查
            exit 1
          fi
          echo "✅ 找到main.py，开始清理Nix相关代码"
          # 批量删除Nix相关代码，脱离Nix依赖
          sed -i '/install_nix/d' main.py
          sed -i '/nix-shell/d' main.py
          sed -i '/Nix\|nix/d' main.py
          # 验证：无Nix代码残留则继续，否则报错
          if grep -q -i "nix" main.py; then
            echo "❌ 检测到Nix相关代码残留，请检查main.py"
            exit 1
          else
            echo "✅ 已成功移除所有Nix相关逻辑"
          fi
        shell: /usr/bin/bash -e {0}

      - name: 6. 项目初始化（自动拉取核心工具，不启动服务）
        run: |
          cd $GITHUB_WORKSPACE
          source .venv/bin/activate
          # 添加执行权限
          chmod +x main.py
          # 启动后3秒停止，仅完成apple-music-downloader/wrapper拉取
          python3 main.py 2>&1 &
          sleep 3
          # 安全停止服务，避免Actions挂起
          pkill -f "python3 main.py" || echo "服务已正常停止"
          echo "✅ 项目初始化完成，已自动拉取所有核心工具"

      - name: 7. 打包完整可运行产物（保留所有核心文件）
        run: |
          cd $GITHUB_WORKSPACE
          # 创建产物目录
          mkdir -p dist
          # 复制所有核心文件，保证解压后可直接运行
          cp -r app/ main.py requirements.txt dist/
          cp -r .venv/ dist/
          cp -r apple-music-downloader/ dist/ 2>/dev/null || echo "apple-music-downloader目录已存在"
          cp -r wrapper/ dist/ 2>/dev/null || echo "wrapper目录已存在"
          # 按Commit SHA命名，便于版本追溯
          zip -r apple-music-rip-ubuntu2404-${{ github.sha }}.zip dist/
          # 验证产物
          ls -lh apple-music-rip-ubuntu2404-${{ github.sha }}.zip
          echo "✅ 产物打包完成，包含所有核心文件和依赖"

      - name: 8. 上传构建产物（保留90天，可直接下载）
        uses: actions/upload-artifact@v4
        with:
          name: apple-music-rip-ubuntu2404-build
          path: $GITHUB_WORKSPACE/apple-music-rip-ubuntu2404-${{ github.sha }}.zip
          retention-days: 90
          if-no-files-found: error # 无产物则构建失败

      - name: 9. 验证产物基础运行（确保可正常启动）
        run: |
          cd $GITHUB_WORKSPACE/dist
          source .venv/bin/activate
          # 后台启动项目并记录日志
          python3 main.py 2>&1 > run.log &
          sleep 5 # 等待服务完全启动
          # 检查5000端口（原项目默认端口）是否监听
          if netstat -tulpn | grep -q 5000; then
            echo "✅ 产物验证成功：项目正常启动，5000端口已监听"
          else
            echo "❌ 产物验证失败，运行日志如下："
            cat run.log
            exit 1
          fi
          # 停止服务，结束构建
          pkill -f "python3 main.py"
